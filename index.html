--- START OF FILE couponV16.html ---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Galactic Kuji - V16</title>
    <style>
        :root {
            --xmas-red: #d42426;
            --xmas-green: #165b33;
            --gold: #f5b942;
        }
        body { margin: 0; overflow: hidden; background-color: #050510; color: #eee; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; user-select: none; touch-action: none; }
        
        #bg-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('./images/bg.png');
            background-size: cover; background-position: center; z-index: 0;
            background-color: #1a1a2e;
        }

        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; z-index: 1; }
        
        #video-container { 
            position: fixed; bottom: 20px; right: 20px; width: 160px; height: 120px; 
            border: 3px solid var(--gold); border-radius: 15px; overflow: hidden; z-index: 100; 
            background: #000; box-shadow: 0 0 15px var(--gold); transform: scaleX(-1); 
        }
        #video-input { width: 100%; height: 100%; object-fit: cover; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 25px; box-sizing: border-box; }
        
        .inventory-card {
            background: rgba(20, 20, 20, 0.85); border: 2px solid var(--gold); border-radius: 20px;
            padding: 20px; width: 220px; pointer-events: auto; backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .inventory-card h2 { 
            margin: 0 0 15px 0; font-size: 1rem; text-align: center; color: var(--gold); 
            border-bottom: 1px solid var(--gold); padding-bottom: 10px;
        }
        .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-weight: 900; font-size: 1.1rem; }
        .stat-label { display: flex; align-items: center; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .count-num { font-family: 'Courier New', monospace; background: #000; padding: 2px 10px; border-radius: 5px; border: 1px solid #444; }

        #last-warning {
            margin-top: 10px; background: var(--xmas-red); color: white; text-align: center;
            padding: 5px; border-radius: 5px; font-size: 0.8rem; animation: pulse 1s infinite;
            display: none;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .history-mini { margin-top: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; font-size: 0.75rem; height: 120px; overflow-y: auto; }
        .history-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding: 5px 0; display: flex; justify-content: space-between; }

        #gesture-hint { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); text-align: center; opacity: 0; transition: 0.4s; z-index: 5; }
        #hint-text { font-size: 2rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--xmas-red); }
        #power-container { width: 280px; height: 12px; background: rgba(255,255,255,0.1); margin-top: 15px; border-radius: 10px; border: 2px solid #fff; overflow: hidden; }
        #power-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--xmas-red), var(--gold)); transition: width 0.2s; }

        /* ç»“æœæ¡†ä¼˜åŒ–ï¼šå›¾ç‰‡å…¨å±•ç¤º */
        #result-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(15px); }
        #result-card { width: 340px; background: #fff; border-radius: 30px; overflow: hidden; transform: scale(0.8); opacity: 0; transition: 0.6s cubic-bezier(0.17, 0.89, 0.32, 1.27); text-align: center; border: 8px solid var(--gold); }
        #result-card.show { transform: scale(1); opacity: 1; }
        .coupon-img { width: 100%; height: 380px; object-fit: contain; background: #fff; display: block; }
        .coupon-body { padding: 15px 20px 25px 20px; background: white; color: #333; }
        .tier-badge { font-size: 1.8rem; font-weight: 900; color: var(--xmas-red); margin-bottom: 15px; }
        #res-name { display: none; } /* æŒ‰è¦æ±‚éšè—åç§°å±•ç¤º */
        .btn-continue { background: var(--xmas-green); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1rem; }

        #start-prompt { position: fixed; inset: 0; background: #050510; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .btn-launch { background: var(--xmas-red); color: #fff; border: 4px solid var(--gold); padding: 25px 60px; font-size: 1.5rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px rgba(212, 36, 38, 0.5); transition: transform 0.2s; }
        
        #cursor-tracker { position: absolute; width: 40px; height: 40px; border: 3px solid var(--gold); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 100; display: none; box-shadow: 0 0 15px var(--gold); }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="bg-overlay"></div>
    <div class="snow-container" id="snow"></div>

    <audio id="bgm" loop>
        <source src="./audio/100coffee.mp3" type="audio/mpeg">
    </audio>

    <div id="video-container"><video id="video-input"></video></div>

    <div id="start-prompt">
        <h1 style="color:var(--gold); font-size: 3rem; margin-bottom:10px; text-shadow: 0 0 20px var(--xmas-red);">MERRY</h1>
        <h2 style="color:#fff; letter-spacing:10px; margin-bottom:40px;">CHRISTMAS KUJI</h2>
        <button class="btn-launch" onclick="initApp()">å¼€å¯æŠ½å¥–</button>
    </div>

    <div id="canvas-container"></div>
    <div id="cursor-tracker"></div>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="inventory-card">
                <h2>å½“å‰å¥–æ± å‰©ä½™</h2>
                <div class="stat-row">
                    <div class="stat-label"><div class="dot" style="background:#ff00ff"></div> S èµ</div>
                    <div class="count-num" id="count-s" style="color:#ff00ff">0</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><div class="dot" style="background:#ffae00"></div> A èµ</div>
                    <div class="count-num" id="count-a" style="color:#ffae00">0</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><div class="dot" style="background:#00f2ff"></div> B èµ</div>
                    <div class="count-num" id="count-b" style="color:#00f2ff">0</div>
                </div>
                <div id="last-warning">ğŸ LAST èµæ¿€æ´»ï¼</div>
                <div class="history-mini"><div id="history-list"></div></div>
            </div>
        </div>
        <div id="gesture-hint">
            <div id="hint-text">PUNCH!</div>
            <p style="color: #fff; font-size: 0.8rem; margin: 5px 0;">(æ¨å‘é•œå¤´å¯è¿”å›)</p>
            <div id="power-container"><div id="power-fill"></div></div>
        </div>
    </div>

    <div id="result-overlay">
        <div id="result-card">
            <img src="" id="res-img" class="coupon-img">
            <div class="coupon-body">
                <div id="res-tier-badge" class="tier-badge"></div>
                <div id="res-name"></div>
                <button class="btn-continue" onclick="continueKuji()">æ”¶ä¸‹ç¤¼ç‰©</button>
            </div>
        </div>
    </div>

<script>
// --- [1] é…ç½® ---
const TIER_CONFIG = {
    S: { qty: 1, name: "è±ªåå¤§å¥–", img: "./images/Så¥–å“å’–å•¡æ¬¡å¡ä¼˜æƒ åˆ¸.png" },
    A: { qty: 1, name: "é«˜çº§ç¤¼å“", img: "./images/Aå¥–å“ç¾å¼å¤©å¡ä¼˜æƒ åˆ¸.png" },
    B: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Bå¥–å“25å…ƒä»£é‡‘åˆ¸.png" },
    C: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Cå¥–å“15å…ƒä»£é‡‘åˆ¸.png" },
    D: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Då¥–å“åŒå€ç¾å¼åˆ¸.png" },
    E: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Eå¥–å“æ»¡å‡åˆ¸.png" },
    F: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Få¥–å“æ»¡å‡åˆ¸.png" },
    G: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Gå¥–å“æ»¡å‡åˆ¸.png" },
    H: { qty: 2, name: "å¹¸è¿å‘¨è¾¹", img: "./images/Hå¥–å“ä¹°äºŒé€ä¸€åˆ¸.png" },
    LAST: { name: "æœ€ç»ˆèµ", img: "https://images.unsplash.com/photo-1543589077-47d81606c1bf?w=500" }
};

let GIFT_POOL = [];
let WIN_HISTORY = [];

function buildPool() {
    GIFT_POOL = [];
    for (const tier in TIER_CONFIG) {
        if(tier === 'LAST') continue;
        for (let i = 0; i < TIER_CONFIG[tier].qty; i++) {
            GIFT_POOL.push({ tier, ...TIER_CONFIG[tier] });
        }
    }
}

// --- [2] éŸ³æ•ˆ ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const SFX = {
    hit: (v) => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(200 + v*100, audioCtx.currentTime);
        g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    },
    explode: () => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1, audioCtx.currentTime + 0.5);
        g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    },
    cancel: () => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    }
};

// --- [3] 3D åœºæ™¯ ---
let scene, camera, renderer, clock, gifts = [], fragments = [];
let currentState = 0; 
let activeGift = null, smoothIndex = 0, activeIndex = 0, swipeVelocity = 0;
let fistCount = 0, isFistDetected = false, handDepthBase = 0;
const RADIUS = 14;

function initApp() {
    document.getElementById('start-prompt').style.display = 'none';
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.5; // [ä¿®æ”¹1] èƒŒæ™¯éŸ³ä¹éŸ³é‡è°ƒå°50%
    bgm.play().catch(e => console.warn("Audio play failed", e));
    if(audioCtx.state === 'suspended') audioCtx.resume();
    
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 2, 10);
    
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const mainLight = new THREE.DirectionalLight(0xffd700, 1.2);
    mainLight.position.set(5, 10, 7);
    mainLight.castShadow = true;
    scene.add(mainLight);

    buildPool();
    createSnowflakes();
    refreshCarousel();
    updateUI();
    setupHandTracking();
    clock = new THREE.Clock();
    animate();
}

function createGiftBox() {
    const group = new THREE.Group();
    const colors = [0xd42426, 0x165b33, 0x1e90ff, 0xffffff, 0x8b4513];
    const wrapColor = colors[Math.floor(Math.random() * colors.length)];
    const boxSize = 2.5;

    const body = new THREE.Mesh(
        new THREE.BoxGeometry(boxSize, boxSize, boxSize),
        new THREE.MeshStandardMaterial({ color: wrapColor, roughness: 0.6, metalness: 0.1 })
    );
    body.castShadow = true; group.add(body);

    const ribbonMat = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.2, metalness: 0.6 });
    const bandWidth = 0.4;
    const bandThickness = boxSize + 0.05;
    group.add(new THREE.Mesh(new THREE.BoxGeometry(bandWidth, bandThickness, bandThickness), ribbonMat));
    group.add(new THREE.Mesh(new THREE.BoxGeometry(bandThickness, bandThickness, bandWidth), ribbonMat));
    
    return group;
}

function refreshCarousel() {
    gifts.forEach(g => scene.remove(g));
    gifts = [];
    GIFT_POOL.forEach((data, i) => {
        const gift = createGiftBox();
        gift.userData = { prize: data };
        scene.add(gift);
        gifts.push(gift);
    });
}

function onHandResults(res) {
    if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) return;
    const lm = res.multiHandLandmarks[0];
    const indexTip = lm[8], thumbTip = lm[4], wrist = lm[0], middleBase = lm[9];
    
    const tracker = document.getElementById('cursor-tracker');
    tracker.style.display = 'block'; 
    tracker.style.left = (1-indexTip.x)*window.innerWidth + 'px'; 
    tracker.style.top = indexTip.y*window.innerHeight + 'px';

    // è®¡ç®—æ‰‹æŒå¤§å°ï¼ˆåˆ¤æ–­å‰åæ·±åº¦ï¼‰
    const palmSize = Math.hypot(wrist.x - middleBase.x, wrist.y - middleBase.y);

    if (currentState === 0) {
        const dx = indexTip.x - (window._lastX || indexTip.x);
        swipeVelocity += dx * 1.5;
        window._lastX = indexTip.x;

        const pinch = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
        if (pinch < 0.05 && Math.abs(indexTip.x - 0.5) < 0.2) {
            const total = gifts.length;
            const idx = (Math.round(smoothIndex) % total + total) % total;
            if (gifts[idx]) {
                activeGift = gifts[idx];
                currentState = 1; fistCount = 0;
                handDepthBase = palmSize; // [æ–°å¢] è®°å½•é€‰ä¸­æ—¶çš„åˆå§‹æ‰‹æŒå¤§å°
                document.getElementById('gesture-hint').style.opacity = 1;
            }
        }
    } else if (currentState === 1) {
        // [ä¿®æ”¹3] æ–°å¢è¿”å›æ‰‹åŠ¿ï¼šæ‰‹æŒæ¨å‘æ‘„åƒå¤´ (palmSize å˜å¤§)
        const fingerTips = [8, 12, 16, 20];
        const isOpen = fingerTips.every(i => Math.hypot(lm[i].x - wrist.x, lm[i].y - wrist.y) > 0.35);
        
        if (isOpen && palmSize > handDepthBase * 1.35) {
            deselectGift();
            return;
        }

        const isFist = fingerTips.every(i => Math.hypot(lm[i].x - wrist.x, lm[i].y - wrist.y) < 0.25);
        if (isFist && !isFistDetected) {
            fistCount++;
            SFX.hit(fistCount);
            activeGift.scale.setScalar(0.85); 
            activeGift.rotation.x = 0.5;
            document.getElementById('power-fill').style.width = (fistCount/3*100)+'%';
            if (fistCount >= 3) explodeGift();
        }
        isFistDetected = isFist;
    }
}

function deselectGift() {
    SFX.cancel();
    currentState = 0;
    activeGift = null;
    document.getElementById('gesture-hint').style.opacity = 0;
    document.getElementById('power-fill').style.width = '0%';
}

function explodeGift() {
    currentState = 2;
    SFX.explode();
    document.getElementById('gesture-hint').style.opacity = 0;

    let prize = activeGift.userData.prize;
    if (GIFT_POOL.length === 1) prize = { tier: "LAST", ...TIER_CONFIG.LAST };

    WIN_HISTORY.unshift({ tier: prize.tier, name: prize.name, time: new Date().toLocaleTimeString() });
    GIFT_POOL = GIFT_POOL.filter(g => g !== activeGift.userData.prize);
    
    for(let i=0; i<30; i++) {
        const frag = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), activeGift.children[0].material);
        frag.position.copy(activeGift.position);
        frag.userData.vel = new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5)+1, (Math.random()-0.5));
        scene.add(frag); fragments.push(frag);
    }
    activeGift.visible = false;
    setTimeout(() => showResult(prize), 800);
}

function showResult(prize) {
    document.getElementById('res-img').src = prize.img;
    document.getElementById('res-tier-badge').innerText = (prize.tier === 'LAST' ? "æœ€ç»ˆèµ" : prize.tier + " èµ");
    // [ä¿®æ”¹2] res-name åœ¨ CSS ä¸­è®¾ä¸º display:none
    const overlay = document.getElementById('result-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => document.getElementById('result-card').classList.add('show'), 50);
}

function continueKuji() {
    document.getElementById('result-overlay').style.display = 'none';
    document.getElementById('result-card').classList.remove('show');
    fragments.forEach(f => scene.remove(f));
    fragments = [];
    if (GIFT_POOL.length === 0) { alert("æ‰€æœ‰å¥–å“å·²æŠ½å®Œï¼"); location.reload(); }
    else { refreshCarousel(); updateUI(); currentState = 0; }
}

function updateUI() {
    document.getElementById('count-s').innerText = GIFT_POOL.filter(g => g.tier === "S").length;
    document.getElementById('count-a').innerText = GIFT_POOL.filter(g => g.tier === "A").length;
    document.getElementById('count-b').innerText = GIFT_POOL.filter(g => g.tier === "B").length;
    document.getElementById('last-warning').style.display = GIFT_POOL.length === 1 ? 'block' : 'none';
    document.getElementById('history-list').innerHTML = WIN_HISTORY.map(h => `
        <div class="history-item"><span style="color:var(--gold)">[${h.tier}]</span><span>æŠ½ä¸­ç¤¼ç‰©</span></div>
    `).join('');
}

function animate() {
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();

    if (currentState === 0) {
        activeIndex += swipeVelocity;
        swipeVelocity *= 0.95;
        smoothIndex += (activeIndex - smoothIndex) * 0.1;
        gifts.forEach((g, i) => {
            const angle = (i - smoothIndex) * (Math.PI * 2 / gifts.length);
            g.position.set(Math.sin(angle) * RADIUS, Math.sin(time + i) * 0.5, Math.cos(angle) * RADIUS - RADIUS);
            g.rotation.y = -angle + time * 0.3;
            g.visible = true;
        });
    } else if (currentState === 1) {
        activeGift.position.lerp(new THREE.Vector3(0, 2, 6), 0.1);
        activeGift.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
        activeGift.rotation.x = THREE.MathUtils.lerp(activeGift.rotation.x, 0, 0.1);
        activeGift.rotation.y += 0.02;
        gifts.forEach(g => { if(g !== activeGift) g.visible = false; });
    }

    fragments.forEach((f) => {
        f.position.add(f.userData.vel); 
        f.userData.vel.y -= 0.03; 
        f.rotation.x += 0.1;
    });

    renderer.render(scene, camera);
}

async function setupHandTracking() {
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.75 });
    hands.onResults(onHandResults);
    const cam = new Camera(document.getElementById('video-input'), {
        onFrame: async () => { await hands.send({image: document.getElementById('video-input')}); },
        width: 640, height: 480
    });
    cam.start();
}

function createSnowflakes() {
    const container = document.getElementById('snow');
    for(let i=0; i<50; i++) {
        const flake = document.createElement('div');
        flake.innerHTML = 'â„';
        flake.className = 'flake';
        flake.style.cssText = `position:absolute;color:white;left:${Math.random()*100}vw;animation:snow-fall ${Math.random()*5+5}s linear infinite;opacity:${Math.random()};font-size:${Math.random()*20+10}px;`;
        container.appendChild(flake);
    }
}
const style = document.createElement('style');
style.innerHTML = `@keyframes snow-fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }`;
document.head.appendChild(style);
</script>
</body>
</html>