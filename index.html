--- START OF FILE couponV25.html ---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Nebula Kuji</title>
    <style>
        :root {
            --xmas-red: #ff3e3e;
            --xmas-green: #2ecc71;
            --gold: #f5b942;
            --glass: rgba(10, 10, 25, 0.9);
        }
        body { margin: 0; overflow: hidden; background-color: #020205; color: #eee; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
        
        #bg-overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, #1a1a3a 0%, #050510 100%); z-index: 0; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; z-index: 1; }
        
        /* èµ›åšå‡†æ˜Ÿå…‰æ ‡ */
        #hand-cursor {
            position: fixed; width: 24px; height: 24px;
            border: 1px solid var(--gold); border-radius: 50%;
            pointer-events: none; z-index: 999; display: none;
            transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s;
        }
        #hand-cursor::before, #hand-cursor::after {
            content: ''; position: absolute; background: var(--gold);
        }
        #hand-cursor::before { width: 100%; height: 1px; top: 50%; left: 0; }
        #hand-cursor::after { height: 100%; width: 1px; left: 50%; top: 0; }
        #hand-cursor.pinched { 
            width: 40px; height: 40px; border-color: var(--xmas-red); 
            background: rgba(255, 62, 62, 0.1); box-shadow: 0 0 20px var(--xmas-red); 
        }

        #video-container { position: fixed; bottom: 15px; right: 15px; width: 110px; height: 85px; border: 2px solid var(--gold); border-radius: 10px; overflow: hidden; z-index: 100; transform: scaleX(-1); background: #000; opacity: 0.8; }
        #video-input { width: 100%; height: 100%; object-fit: cover; }

        #music-ctrl { position: fixed; top: 15px; right: 15px; z-index: 100; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 20px; background: var(--glass); border: 1px solid var(--gold); }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; gap: 10px; }
        
        .glass-card { background: var(--glass); border: 1px solid var(--gold); border-radius: 12px; padding: 10px; pointer-events: auto; backdrop-filter: blur(15px); }
        
        .inventory-card { width: 140px; }
        .inventory-card h2 { margin: 0 0 8px 0; font-size: 0.8rem; text-align: center; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.75rem; }
        .count-num { color: var(--gold); font-family: monospace; }

        .history-card { width: 140px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .history-card h2 { margin: 0; font-size: 0.75rem; color: var(--gold); }
        .history-card.collapsed #history-content { display: none; }
        
        #history-list { font-size: 0.65rem; max-height: 15vh; overflow-y: auto; margin-top: 5px; }
        .history-item { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #ccc; }

        #result-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 200; }
        #result-card { width: 85vw; max-width: 350px; background: #fff; border-radius: 20px; overflow: hidden; transform: scale(0.8); opacity: 0; transition: 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.27); text-align: center; }
        #result-card.show { transform: scale(1); opacity: 1; }
        .coupon-img { width: 100%; height: auto; background: #fff; }
        .btn-continue { background: #000; color: #fff; border: none; padding: 15px; width: 100%; font-size: 1rem; font-weight: bold; }

        #gesture-hint { position: absolute; top: 18%; left: 50%; transform: translateX(-50%); text-align: center; opacity: 0; transition: 0.4s; }
        #hint-text { font-size: 1.8rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--xmas-red); }
        #power-bar { width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 10px auto; overflow: hidden; }
        #power-fill { width: 0%; height: 100%; background: var(--xmas-red); box-shadow: 0 0 10px var(--xmas-red); }

        #start-prompt { position: fixed; inset: 0; background: #020205; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .btn-launch { background: transparent; color: var(--gold); border: 2px solid var(--gold); padding: 15px 40px; font-size: 1.2rem; border-radius: 30px; cursor: pointer; transition: 0.3s; }
        .btn-launch:hover { background: var(--gold); color: #000; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="hand-cursor"></div>
    <div id="bg-overlay"></div>
    <audio id="bgm" loop><source src="./audio/100coffee.mp3" type="audio/mpeg"></audio>
    <div id="music-ctrl" onclick="toggleMusic()">ğŸµ</div>

    <div id="video-container"><video id="video-input"></video></div>

    <div id="start-prompt">
        <h1 style="color:var(--gold); font-size: 2.5rem; margin-bottom:10px; letter-spacing:5px;">NEBULA KUJI</h1>
        <p style="color:#888; margin-bottom:30px;">ä½¿ç”¨æ‰‹åŠ¿æ§åˆ¶æ—‹æ¶¡ï¼Œæåˆé€‰å–ç¤¼ç‰©</p>
        <button class="btn-launch" onclick="initApp()">ENTER SYSTEM</button>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="glass-card inventory-card">
            <h2>Pool Status</h2>
            <div id="inventory-list"></div>
        </div>

        <div class="glass-card history-card collapsed" id="history-panel">
            <div class="history-header" onclick="toggleHistory()">
                <h2>Recent Wins</h2>
                <span style="font-size: 0.6rem;">â–¼</span>
            </div>
            <div id="history-content">
                <div id="history-list"></div>
            </div>
        </div>

        <div id="gesture-hint">
            <div id="hint-text">PUNCH TO OPEN!</div>
            <div id="power-bar"><div id="power-fill"></div></div>
        </div>
    </div>

    <div id="result-overlay">
        <div id="result-card">
            <img src="" id="res-img" class="coupon-img">
            <div style="padding: 20px;">
                <div id="res-tier-badge" style="font-size: 1.5rem; font-weight: bold; color: #d42426; margin-bottom: 15px;"></div>
                <button class="btn-continue" onclick="continueKuji()">ACCEPT GIFT</button>
            </div>
        </div>
    </div>

<script>
// --- [é…ç½®ä¸é€»è¾‘] ---
const TIER_CONFIG = {
    S: { qty: 1, name: "å’–å•¡æ¬¡å¡", img: "./images/Så¥–å“å’–å•¡æ¬¡å¡ä¼˜æƒ åˆ¸.png", color: 0xffd700 },
    A: { qty: 2, name: "ç¾å¼å¤©å¡", img: "./images/Aå¥–å“ç¾å¼å¤©å¡ä¼˜æƒ åˆ¸.png", color: 0xe5e4e2 },
    B: { qty: 3, name: "25å…ƒä»£é‡‘åˆ¸", img: "./images/Bå¥–å“25å…ƒä»£é‡‘åˆ¸.png", color: 0xff8c00 },
    C: { qty: 3, name: "15å…ƒä»£é‡‘åˆ¸", img: "./images/Cå¥–å“15å…ƒä»£é‡‘åˆ¸.png", color: 0x00bfff },
    D: { qty: 5, name: "åŒå€ç¾å¼åˆ¸", img: "./images/Då¥–å“åŒå€ç¾å¼åˆ¸.png", color: 0x7fff00 },
    E: { qty: 5, name: "æ»¡å‡åˆ¸E", img: "./images/Eå¥–å“æ»¡å‡åˆ¸.png", color: 0xff69b4 },
    F: { qty: 5, name: "æ»¡å‡åˆ¸F", img: "./images/Få¥–å“æ»¡å‡åˆ¸.png", color: 0xba55d3 },
    G: { qty: 5, name: "æ»¡å‡åˆ¸G", img: "./images/Gå¥–å“æ»¡å‡åˆ¸.png", color: 0x40e0d0 },
    H: { qty: 10, name: "ä¹°äºŒé€ä¸€", img: "./images/Hå¥–å“ä¹°äºŒé€ä¸€åˆ¸.png", color: 0xffffff },
    LAST: { name: "æœ€ç»ˆå¤§å¥–", img: "https://images.unsplash.com/photo-1543589077-47d81606c1bf?w=500", color: 0xff3e3e }
};

let GIFT_POOL = [], WIN_HISTORY = [], isMusicOn = true;

function buildPool() {
    GIFT_POOL = [];
    for (const tier in TIER_CONFIG) {
        if(tier === 'LAST') continue;
        for (let i = 0; i < TIER_CONFIG[tier].qty; i++) {
            GIFT_POOL.push({ tier, ...TIER_CONFIG[tier] });
        }
    }
}

function toggleMusic() {
    const bgm = document.getElementById('bgm'), btn = document.getElementById('music-ctrl');
    isMusicOn = !isMusicOn;
    isMusicOn ? bgm.play() : bgm.pause();
    btn.innerText = isMusicOn ? "ğŸµ" : "ğŸ”‡";
}

function toggleHistory() { document.getElementById('history-panel').classList.toggle('collapsed'); }

function updateInventoryUI() {
    const container = document.getElementById('inventory-list');
    container.innerHTML = '';
    Object.keys(TIER_CONFIG).filter(t => t !== 'LAST').forEach(tier => {
        const count = GIFT_POOL.filter(g => g.tier === tier).length;
        const row = document.createElement('div');
        row.className = 'stat-row';
        row.innerHTML = `<span>${tier} Award</span><span class="count-num">${count}</span>`;
        if(count === 0) row.style.opacity = '0.3';
        container.appendChild(row);
    });
}

function addHistory(prize) {
    WIN_HISTORY.unshift(`[${prize.tier}] ${prize.name}`);
    const list = document.getElementById('history-list');
    list.innerHTML = WIN_HISTORY.slice(0, 10).map(h => `<div class="history-item">${h}</div>`).join('');
}

// --- [3D å¼•æ“ - æ˜Ÿäº‘æ—‹æ¶¡] ---
let scene, camera, renderer, clock, gifts = [];
let currentState = 0, activeGift = null, smoothIndex = 0, activeIndex = 0, swipeVelocity = 0;
let fistCount = 0, isFistDetected = false, handDepthBase = 0;
const cursorEl = document.getElementById('hand-cursor');

function initApp() {
    document.getElementById('start-prompt').style.display = 'none';
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.4; bgm.play().catch(()=>{});
    
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 20);
    
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // å…‰å½±ç¯å¢ƒ
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const pLight = new THREE.PointLight(0xf5b942, 2, 50);
    pLight.position.set(0, 0, 10);
    scene.add(pLight);

    buildPool();
    refreshCarousel();
    updateInventoryUI();
    setupHandTracking();
    clock = new THREE.Clock();
    animate();
}

// 2. æƒŠè‰³çš„ç¤¼ç‰©ç›’æ ·å¼ï¼šåŠé€æ˜ç»ç’ƒ + æ ¸å¿ƒå‘å…‰
function createGiftBox(tierColor) {
    const group = new THREE.Group();
    
    // å¤–éƒ¨ç»ç’ƒå£³
    const shellGeo = new THREE.BoxGeometry(2, 2, 2);
    const shellMat = new THREE.MeshStandardMaterial({ 
        color: tierColor, transparent: true, opacity: 0.4, 
        metalness: 0.9, roughness: 0.1, envMapIntensity: 1 
    });
    const shell = new THREE.Mesh(shellGeo, shellMat);
    group.add(shell);

    // å†…éƒ¨å‘å…‰æ ¸å¿ƒ
    const coreGeo = new THREE.SphereGeometry(0.6, 16, 16);
    const coreMat = new THREE.MeshBasicMaterial({ color: tierColor });
    const core = new THREE.Mesh(coreGeo, coreMat);
    group.add(core);

    // è£…é¥°æ¡†
    const frame = new THREE.BoxHelper(shell, 0xffffff);
    frame.material.opacity = 0.5;
    frame.material.transparent = true;
    group.add(frame);

    group.userData = { core, shell, baseColor: tierColor };
    return group;
}

function refreshCarousel() {
    gifts.forEach(g => scene.remove(g));
    gifts = [];
    GIFT_POOL.forEach((data) => {
        const gift = createGiftBox(data.color);
        gift.userData.prize = data;
        scene.add(gift);
        gifts.push(gift);
    });
}

function onHandResults(res) {
    if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) {
        cursorEl.style.display = 'none'; return;
    }
    const lm = res.multiHandLandmarks[0];
    const indexTip = lm[8], thumbTip = lm[4], wrist = lm[0], midBase = lm[9];
    const visualX = (1 - indexTip.x); 
    
    cursorEl.style.display = 'block';
    cursorEl.style.left = (visualX * 100) + 'vw';
    cursorEl.style.top = (indexTip.y * 100) + 'vh';

    const palmSize = Math.hypot(wrist.x - midBase.x, wrist.y - midBase.y);

    if (currentState === 0) {
        // æŒç»­åå‘æ»‘åŠ¨
        const diff = visualX - 0.5;
        if (Math.abs(diff) > 0.08) {
            swipeVelocity -= diff * 0.05; 
        }
        swipeVelocity = Math.max(-0.8, Math.min(0.8, swipeVelocity));

        // æåˆæ£€æµ‹
        const pinchDist = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
        const isPinching = pinchDist < 0.05;
        isPinching ? cursorEl.classList.add('pinched') : cursorEl.classList.remove('pinched');

        if (isPinching && Math.abs(visualX - 0.5) < 0.15 && Math.abs(indexTip.y - 0.5) < 0.2) {
            // åœ¨æ—‹æ¶¡ä¸­å¿ƒæåˆ
            const total = gifts.length;
            const idx = (Math.round(smoothIndex) % total + total) % total;
            if (gifts[idx]) {
                activeGift = gifts[idx];
                currentState = 1; fistCount = 0;
                handDepthBase = palmSize;
                document.getElementById('gesture-hint').style.opacity = 1;
            }
        }
    } else if (currentState === 1) {
        // å‡»æ‰“æ£€æµ‹
        const isFist = [8,12,16,20].every(i => Math.hypot(lm[i].x - wrist.x, lm[i].y - wrist.y) < 0.25);
        if (isFist && !isFistDetected) {
            fistCount++;
            document.getElementById('power-fill').style.width = (fistCount/3*100)+'%';
            activeGift.scale.setScalar(0.85);
            if (fistCount >= 3) explodeGift();
        }
        isFistDetected = isFist;

        // å–æ¶ˆæåˆè¿”å›
        const isOpen = [8,12,16,20].every(i => Math.hypot(lm[i].x - wrist.x, lm[i].y - wrist.y) > 0.35);
        if (isOpen && palmSize > handDepthBase * 1.3) {
            currentState = 0; activeGift = null;
            document.getElementById('gesture-hint').style.opacity = 0;
        }
    }
}

function explodeGift() {
    currentState = 2;
    document.getElementById('gesture-hint').style.opacity = 0;
    let prize = activeGift.userData.prize;
    if (GIFT_POOL.length === 1) prize = { tier: "LAST", ...TIER_CONFIG.LAST };
    GIFT_POOL = GIFT_POOL.filter(g => g !== activeGift.userData.prize);
    addHistory(prize);
    updateInventoryUI();
    activeGift.visible = false;
    setTimeout(() => {
        document.getElementById('res-img').src = prize.img;
        document.getElementById('res-tier-badge').innerText = prize.tier === 'LAST' ? "LAST ONE AWARD" : prize.tier + " AWARD";
        document.getElementById('result-overlay').style.display = 'flex';
        setTimeout(() => document.getElementById('result-card').classList.add('show'), 50);
    }, 600);
}

function continueKuji() {
    document.getElementById('result-overlay').style.display = 'none';
    document.getElementById('result-card').classList.remove('show');
    if (GIFT_POOL.length === 0) { alert("Congratulations! All gifts have been collected."); location.reload(); }
    else { refreshCarousel(); currentState = 0; }
}

function animate() {
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    
    if (currentState === 0) {
        activeIndex += swipeVelocity;
        swipeVelocity *= 0.94;
        smoothIndex += (activeIndex - smoothIndex) * 0.1;

        gifts.forEach((g, i) => {
            const offset = (i - smoothIndex);
            const total = gifts.length;
            let wrapOffset = ((offset + total / 2) % total + total) % total - total / 2;

            // --- æƒŠè‰³çš„â€œæ˜Ÿäº‘æ—‹æ¶¡â€è·¯å¾„ ---
            const angle = wrapOffset * (Math.PI / 5);
            const radius = 6 + Math.abs(wrapOffset) * 2; // è¶Šè¿œè¶Šå®½
            
            const x = Math.sin(angle) * radius;
            const y = Math.cos(angle) * radius * 0.3; // æ‰å¹³æ—‹æ¶¡
            const z = -Math.abs(wrapOffset) * 8 + 5; // æ·±åº¦å˜åŒ–

            g.position.set(x, y, z);
            g.rotation.set(t*0.5, angle, t*0.3);
            
            // æ ¸å¿ƒå‘¼å¸åŠ¨ç”»
            const s = 1 + Math.sin(t * 3 + i) * 0.2;
            g.userData.core.scale.setScalar(s);
            
            // ä¸­å¤®é«˜äº®åé¦ˆ
            const focus = Math.max(0, 1 - Math.abs(wrapOffset));
            g.userData.shell.material.opacity = 0.4 + focus * 0.6;
            g.scale.setScalar(0.8 + focus * 0.4);

            g.visible = z > -60; // å‰ªè£è¿‡è¿œçš„
        });
    } else if (currentState === 1) {
        activeGift.position.lerp(new THREE.Vector3(0, 0, 12), 0.15);
        activeGift.scale.lerp(new THREE.Vector3(1.5, 1.5, 1.5), 0.15);
        activeGift.rotation.y += 0.1;
        gifts.forEach(g => { if(g !== activeGift) g.visible = false; });
    }
    
    renderer.render(scene, camera);
}

async function setupHandTracking() {
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.65 });
    hands.onResults(onHandResults);
    const cam = new Camera(document.getElementById('video-input'), {
        onFrame: async () => { await hands.send({image: document.getElementById('video-input')}); },
        width: 480, height: 360
    });
    cam.start();
}
</script>
</body>
</html>
--- END OF FILE couponV25.html ---